name: Update Channels from URL

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: 'URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞ M3U8 —Ñ–∞–π–ª–∞'
        required: true
        type: string
      update_type:
        description: '–¢–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: manual –∏–ª–∏ auto-check'
        required: true
        default: 'manual'
        type: string

env:
  REPO_NAME: ${{ github.repository }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  update-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Download source M3U8 file
      id: download
      run: |
        echo "–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞: ${{ github.event.inputs.source_url }}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å URL
        if ! curl -f -s -I "${{ github.event.inputs.source_url }}" > /dev/null; then
          echo "‚ùå URL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${{ github.event.inputs.source_url }}"
          exit 1
        fi
        
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        curl -f -s "${{ github.event.inputs.source_url }}" -o source.m3u8
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π M3U —Ñ–∞–π–ª
        if ! grep -q "#EXTM3U" source.m3u8; then
          echo "‚ùå –§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º M3U8"
          exit 1
        fi
        
        echo "‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω"
        echo "source_size=$(wc -l < source.m3u8)" >> $GITHUB_OUTPUT

    - name: Parse and update channels
      id: update
      run: |
        echo "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–Ω–∞–ª–æ–≤..."
        
        # –°–æ–∑–¥–∞–µ–º Node.js —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        cat > update_channels.js << 'EOF'
        const fs = require('fs');
        
        // –°–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const TARGET_CHANNELS = [
            { id: 'pervy', name: '–ü–µ—Ä–≤—ã–π –∫–∞–Ω–∞–ª HD', keywords: ['–ü–µ—Ä–≤—ã–π –∫–∞–Ω–∞–ª', '1TV', '–ü–µ—Ä–≤', '–ü–µ—Ä–≤—ã–π'] },
            { id: 'rossia1', name: '–†–æ—Å—Å–∏—è 1 HD', keywords: ['–†–æ—Å—Å–∏—è 1', 'Rossiya', 'Russia 1'] },
            { id: 'rossia-24', name: '–†–æ—Å—Å–∏—è-24', keywords: ['–†–æ—Å—Å–∏—è-24', 'Rossiya-24', 'Russia-24'] },
            { id: 'kultura', name: '–†–æ—Å—Å–∏—è –ö—É–ª—å—Ç—É—Ä–∞', keywords: ['–†–æ—Å—Å–∏—è –ö—É–ª—å—Ç—É—Ä–∞', 'Kultura', 'Russia K'] },
            { id: 'ntv', name: '–ù–¢–í HD', keywords: ['–ù–¢–í', 'NTV'] },
            { id: 'tnt', name: '–¢–ù–¢ HD', keywords: ['–¢–ù–¢', 'TNT'] },
            { id: 'sts', name: '–°–¢–° HD', keywords: ['–°–¢–°', 'STS'] },
            { id: 'tv3-ru', name: '–¢–í-3 HD', keywords: ['–¢–í-3', 'TV3', 'TV-3'] },
            { id: 'zvezda', name: '–ó–≤–µ–∑–¥–∞ HD', keywords: ['–ó–≤–µ–∑–¥–∞', 'Zvezda'] },
            { id: 'rentv', name: '–†–µ–Ω –¢–í HD', keywords: ['–†–µ–Ω –¢–í', 'REN TV', 'REN-TV'] },
            { id: 'tvcentr', name: '–¢–í –¶–µ–Ω—Ç—Ä HD', keywords: ['–¢–í –¶–µ–Ω—Ç—Ä', 'TV Center', 'TV Centre'] },
            { id: '5kanal-ru', name: '5 –∫–∞–Ω–∞–ª –†–æ—Å—Å–∏—è', keywords: ['5 –∫–∞–Ω–∞–ª', '5-–π –∫–∞–Ω–∞–ª', '5-kanal'] },
            { id: 'domashny', name: '–î–æ–º–∞—à–Ω–∏–π HD', keywords: ['–î–æ–º–∞—à–Ω–∏–π', 'Domashny'] },
            { id: 'pyatnica', name: '–ü—è—Ç–Ω–∏—Ü–∞ HD', keywords: ['–ü—è—Ç–Ω–∏—Ü–∞', 'Friday'] },
            { id: 'mir', name: '–ú–∏—Ä HD', keywords: ['–ú–∏—Ä', 'Mir'] },
            { id: 'otr', name: '–û–¢–† HD', keywords: ['–û–¢–†', 'OTR'] },
            { id: 'rbk', name: '–†–ë–ö', keywords: ['–†–ë–ö', 'RBK'] },
            { id: 'spas', name: '–°–ø–∞—Å', keywords: ['–°–ø–∞—Å', 'Spas'] },
            { id: 'karusel', name: '–ö–∞—Ä—É—Å–µ–ª—å HD', keywords: ['–ö–∞—Ä—É—Å–µ–ª—å', 'Karusel'] },
            { id: 'muztv', name: '–ú—É–∑ –¢–í HD', keywords: ['–ú—É–∑ –¢–í', 'MuzTV', 'MTV'] },
            { id: 'match-tv', name: '–ú–∞—Ç—á! HD', keywords: ['–ú–∞—Ç—á!', 'Match!', 'Match TV'] }
        ];
        
        // –ü–∞—Ä—Å–∏–Ω–≥ M3U —Ñ–∞–π–ª–∞
        function parseM3U(content) {
            const lines = content.split('\n');
            const channels = [];
            let currentChannel = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    const tvgIdMatch = line.match(/tvg-id="([^"]*)"/);
                    const tvgLogoMatch = line.match(/tvg-logo="([^"]*)"/);
                    const groupTitleMatch = line.match(/group-title="([^"]*)"/);
                    const nameMatch = line.match(/,(.+)$/);
                    
                    currentChannel = {
                        extinf: line,
                        tvgId: tvgIdMatch ? tvgIdMatch[1] : '',
                        tvgLogo: tvgLogoMatch ? tvgLogoMatch[1] : '',
                        groupTitle: groupTitleMatch ? groupTitleMatch[1] : '',
                        name: nameMatch ? nameMatch[1] : '',
                        url: ''
                    };
                } else if (line && !line.startsWith('#') && currentChannel) {
                    currentChannel.url = line;
                    channels.push(currentChannel);
                    currentChannel = null;
                }
            }
            
            return channels;
        }
        

        
        // –ü–æ–∏—Å–∫ —Ü–µ–ª–µ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        function findTargetByName(channelName, targetChannels) {
            const normalizedName = channelName.toLowerCase();
            
            for (const target of targetChannels) {
                if (target.name.toLowerCase() === normalizedName) {
                    return target;
                }
                for (const keyword of target.keywords) {
                    if (normalizedName.includes(keyword.toLowerCase())) {
                        return target;
                    }
                }
            }
            
            return null;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã
        const currentContent = fs.readFileSync('files/channels.m3u8', 'utf8');
        const sourceContent = fs.readFileSync('source.m3u8', 'utf8');
        
        // –ü–∞—Ä—Å–∏–º
        const currentChannels = parseM3U(currentContent);
        const sourceChannels = parseM3U(sourceContent);
        
        console.log(`üìä –¢–µ–∫—É—â–∏–µ –∫–∞–Ω–∞–ª—ã: ${currentChannels.length}, –Ω–æ–≤—ã–µ: ${sourceChannels.length}`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏
        let updated = 0;
        const updatedChannels = [];
        
        for (const current of currentChannels) {
            const targetChannel = findTargetByName(current.name, TARGET_CHANNELS);
            if (targetChannel) {
                console.log(`üîç –ò—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–∞–Ω–∞–ª–∞: "${current.name}" (tvg-id: ${targetChannel.id})`);
                
                // –ò—â–µ–º –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ –∫–∞–Ω–∞–ª —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º tvg-id
                let foundSource = null;
                
                // 1. –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ tvg-id + –Ω–∞–∑–≤–∞–Ω–∏–µ
                for (const source of sourceChannels) {
                    if (source.tvgId === targetChannel.id) {
                        if (source.name.toLowerCase() === targetChannel.name.toLowerCase()) {
                            foundSource = source;
                            console.log(`‚úÖ –¢–û–ß–ù–û–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ tvg-id + –Ω–∞–∑–≤–∞–Ω–∏–µ: "${source.name}"`);
                            break;
                        }
                    }
                }
                
                // 2. –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ tvg-id + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
                if (!foundSource) {
                    for (const source of sourceChannels) {
                        if (source.tvgId === targetChannel.id) {
                            const sourceName = source.name.toLowerCase();
                            for (const keyword of targetChannel.keywords) {
                                if (sourceName.includes(keyword.toLowerCase())) {
                                    foundSource = source;
                                    console.log(`‚úÖ –•–û–†–û–®–ï–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ tvg-id + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: "${source.name}"`);
                                    break;
                                }
                            }
                            if (foundSource) break;
                        }
                    }
                }
                
                // 3. –õ—é–±–æ–π –∫–∞–Ω–∞–ª —Å —Ç–∞–∫–∏–º tvg-id
                if (!foundSource) {
                    for (const source of sourceChannels) {
                        if (source.tvgId === targetChannel.id) {
                            foundSource = source;
                            console.log(`‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ tvg-id: "${source.name}"`);
                            break;
                        }
                    }
                }
                
                if (foundSource) {
                    if (current.url !== foundSource.url) {
                        console.log(`üîÑ –û–±–Ω–æ–≤–ª—è–µ–º "${current.name}": ${current.url.substring(0, 50)}... ‚Üí ${foundSource.url.substring(0, 50)}...`);
                        current.url = foundSource.url;
                        updated++;
                    } else {
                        console.log(`‚úÖ URL —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω –¥–ª—è "${current.name}"`);
                    }
                } else {
                    console.log(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è "${current.name}" —Å tvg-id: ${targetChannel.id}`);
                }
            } else {
                console.log(`‚ö†Ô∏è –ö–∞–Ω–∞–ª –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Å–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—è–µ–º—ã—Ö: "${current.name}"`);
            }
            updatedChannels.push(current);
        }
        
        console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${updated} –∫–∞–Ω–∞–ª–æ–≤`);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π M3U —Ñ–∞–π–ª
        let newContent = '#EXTM3U\n';
        for (const channel of updatedChannels) {
            newContent += `${channel.extinf}\n`;
            newContent += `${channel.url}\n\n`;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º
        fs.writeFileSync('files/channels.m3u8', newContent);
        
        // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        console.log(`UPDATED_COUNT=${updated}`);
        process.exit(updated > 0 ? 0 : 1);
        EOF
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç
        if node update_channels.js > update_output.txt 2>&1; then
          UPDATED_COUNT=$(grep "UPDATED_COUNT=" update_output.txt | cut -d'=' -f2)
          echo "updated_count=${UPDATED_COUNT}" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT
          cat update_output.txt
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "updated_count=0" >> $GITHUB_OUTPUT
          cat update_output.txt
        fi

    - name: Update config version
      if: steps.update.outputs.has_changes == 'true'
      run: |
        echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
        
        # –û–±–Ω–æ–≤–ª—è–µ–º timestamp –≤ config.json
        node -e "
        const fs = require('fs');
        const config = JSON.parse(fs.readFileSync('api/config.json', 'utf8'));
        config.channels_config.last_updated = new Date().toISOString();
        config.channels_config.version = Date.now().toString();
        fs.writeFileSync('api/config.json', JSON.stringify(config, null, 2));
        console.log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        "

    - name: Commit and push changes
      if: steps.update.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add files/channels.m3u8
        git add api/config.json
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –∫–æ–º–º–∏—Ç–∞
        SOURCE_HOST=$(echo "${{ github.event.inputs.source_url }}" | sed 's|https\?://||' | cut -d'/' -f1)
        UPDATE_TYPE="${{ github.event.inputs.update_type }}"
        UPDATED_COUNT="${{ steps.update.outputs.updated_count }}"
        
        if [ "$UPDATE_TYPE" = "auto-check" ]; then
          COMMIT_MSG="ü§ñ Auto-update channels from ${SOURCE_HOST} (${UPDATED_COUNT} updated)"
        else
          COMMIT_MSG="üì∫ Manual update channels from ${SOURCE_HOST} (${UPDATED_COUNT} updated)"
        fi
        
        git commit -m "$COMMIT_MSG"
        git push

    - name: Summary
      run: |
        echo "## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **–ò—Å—Ç–æ—á–Ω–∏–∫:** ${{ github.event.inputs.source_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **–¢–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** ${{ github.event.inputs.update_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **–†–∞–∑–º–µ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞:** ${{ steps.download.outputs.source_size }} —Å—Ç—Ä–æ–∫" >> $GITHUB_STEP_SUMMARY
        echo "- **–û–±–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–Ω–∞–ª–æ–≤:** ${{ steps.update.outputs.updated_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **–ï—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:** ${{ steps.update.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.update.outputs.has_changes }}" = "true" ]; then
          echo "‚úÖ **–ö–∞–Ω–∞–ª—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ÑπÔ∏è **–ü–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã**" >> $GITHUB_STEP_SUMMARY
        fi 