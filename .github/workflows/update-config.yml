name: üîß Update Configuration

on:
  workflow_dispatch:
    inputs:
      service_available:
        description: 'Service Available'
        required: true
        default: true
        type: boolean
      maintenance_mode:
        description: 'Maintenance Mode'
        required: true
        default: false
        type: boolean
      message:
        description: 'Message for users'
        required: false
        default: ''
        type: string
      channels_version:
        description: 'Channels Version'
        required: true
        default: '5'
        type: string

jobs:
  update-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üîß Update configuration
        run: |
          # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          CONFIG_FILE="api/config.json"
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          cat > temp_config.json << 'EOF'
          {
            "app_info": {
              "current_version": "1.0",
              "latest_version": "1.1",
              "version_code": 2,
              "download_url": "https://artemon4es.github.io/tv-channels-api/files/updates/app-v1.1.apk",
              "update_required": false,
              "changelog": "üîß –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n‚ú® –£–ª—É—á—à–µ–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è\nüì± –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Android TV"
            },
            "service_config": {
              "service_available": ${{ github.event.inputs.service_available }},
              "message": "${{ github.event.inputs.message }}",
              "maintenance_mode": ${{ github.event.inputs.maintenance_mode }},
              "auth_required": true,
              "auth_endpoint": "https://api.github.com/user",
              "admin_mode": false
            },
            "channels_config": {
              "version": ${{ github.event.inputs.channels_version }},
              "last_updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "url": "https://artemon4es.github.io/tv-channels-api/files/channels.m3u8",
              "security_config_url": "https://artemon4es.github.io/tv-channels-api/files/security_config.xml"
            },
            "api_info": {
              "version": "1.0",
              "last_updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "security_note": "‚ö†Ô∏è –¢–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞ –ù–ï —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø—É–±–ª–∏—á–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
              "endpoints": {
                "config": "/api/config.json",
                "channels": "/files/channels.m3u8",
                "security": "/files/security_config.xml"
              }
            }
          }
          EOF
          
          # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã
          sed -i "s/\$(date -u +%Y-%m-%dT%H:%M:%SZ)/$(date -u +%Y-%m-%dT%H:%M:%SZ)/g" temp_config.json
          
          # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º JSON
          cat temp_config.json | jq '.' > $CONFIG_FILE
          
          # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          rm temp_config.json
          
          echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
          cat $CONFIG_FILE
        
      - name: üìù Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add api/config.json
          
          if git diff --staged --quiet; then
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          else
            git commit -m "üîß Update configuration
            
            Service Available: ${{ github.event.inputs.service_available }}
            Maintenance Mode: ${{ github.event.inputs.maintenance_mode }}
            Message: ${{ github.event.inputs.message }}
            Channels Version: ${{ github.event.inputs.channels_version }}
            
            Updated at: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
            
            git push
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
          fi
          
      - name: üß™ Test API
        run: |
          echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API..."
          sleep 10  # –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GitHub Pages
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ endpoints
          curl -f "https://artemon4es.github.io/tv-channels-api/api/config.json" || echo "‚ùå Config endpoint failed"
          curl -f "https://artemon4es.github.io/tv-channels-api/files/channels.m3u8" || echo "‚ùå Channels endpoint failed"
          curl -f "https://artemon4es.github.io/tv-channels-api/files/security_config.xml" || echo "‚ùå Security endpoint failed"
          
          echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ" 